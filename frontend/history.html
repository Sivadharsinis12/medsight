<!DOCTYPE html>
<html>
<head>
<title>Medical Record History</title>
<link rel="stylesheet" href="css/style.css">
<style>
.history-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 10px;
}

.history-table thead {
  background: #f8fafc;
}

.history-table th {
  padding: 16px;
  text-align: left;
  font-weight: 600;
  color: #475569;
  border-bottom: 2px solid #e2e8f0;
}

.history-table td {
  padding: 16px;
  background: white;
  border-top: 1px solid #e2e8f0;
  border-bottom: 1px solid #e2e8f0;
}

.history-table tr:hover td {
  background: #f8fafc;
}

.risk {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.high { background: #fee2e2; color: #b91c1c; }
.medium { background: #fef3c7; color: #92400e; }
.low { background: #dcfce7; color: #166534; }

.report-item {
  background: #f8fafc;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 12px;
  border: 1px solid #e2e8f0;
}
</style>
</head>
<body>

<div class="navbar">
  <div class="logo">MedInsight AI</div>
  <div class="nav-links">
    <a href="dashboard.html">Dashboard</a>
    <a href="upload.html">Analyze</a>
    <a href="history.html" class="active">History</a>
  </div>
</div>

<div class="container">
  <h1>Medical Record History</h1>
  <p class="subtitle">Review analysis history and patient records</p>

  <!-- FILTERS -->
  <div class="card" style="margin-bottom: 30px;">
    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
      <select id="dateFilter" style="flex: 1; min-width: 150px;">
        <option value="all">Last 30 Days</option>
      </select>
      <input type="text" id="patientIdFilter" placeholder="Patient ID" style="flex: 1; min-width: 150px;">
      <select id="riskFilter" style="flex: 1; min-width: 150px;">
        <option value="all">All Risk Levels</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
      <button class="primary-btn" onclick="applyFilters()" style="width: auto; padding: 12px 25px;">Apply Filters</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <table class="history-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Patient ID</th>
          <th>Diagnosis Summary</th>
          <th>Detected Risk</th>
          <th>AI Recommendation</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

  <!-- SIDE PANEL -->
  <div class="grid-layout" style="margin-top: 30px;">
    <div class="card">
      <h3>Report Archive</h3>
      <div id="reportArchive"></div>
    </div>

    <div class="card" style="background: #e0f2fe; border: 1px solid #bae6fd;">
      <h3>AI Insight</h3>
      <p id="aiInsightText"></p>
    </div>
  </div>

</div>

<script>
// Load analyzed data from upload page
let historyData = JSON.parse(localStorage.getItem("analysisHistory")) || [];

function renderTable(data) {
  const table = document.getElementById("historyTable");
  table.innerHTML = "";

  data.forEach(item => {
    let riskClass = item.risk.toLowerCase();
    table.innerHTML += `
      <tr>
        <td>${item.date}</td>
        <td>${item.patientId}</td>
        <td>${item.diagnosis}</td>
        <td><span class="risk ${riskClass}">${item.risk}</span></td>
        <td>${item.recommendation}</td>
      </tr>
    `;
  });
}

function applyFilters() {
  let risk = document.getElementById("riskFilter").value;
  let id = document.getElementById("patientIdFilter").value.toLowerCase();

  let filtered = historyData.filter(item => {
    return (risk === "all" || item.risk === risk) &&
           (id === "" || item.patientId.toLowerCase().includes(id));
  });

  renderTable(filtered);
}

function renderArchive() {
  const archive = document.getElementById("reportArchive");
  archive.innerHTML = "";
  historyData.slice(0,3).forEach(item=>{
    archive.innerHTML += `
      <div class="report-item">
        ${item.diagnosis}<br>
        <small>${item.date}</small>
      </div>
    `;
  });
}

function renderInsight() {
  const insight = document.getElementById("aiInsightText");
  if(historyData.length === 0){
    insight.innerText = "No analysis data available yet.";
    return;
  }

  const highRiskCount = historyData.filter(d=>d.risk==="High").length;
  insight.innerText = 
    "System detected " + highRiskCount + 
    " high-risk cases based on recent uploaded records. Continuous monitoring recommended.";
}

// Initial Load
renderTable(historyData);
renderArchive();
renderInsight();
</script>

</body>
</html>
